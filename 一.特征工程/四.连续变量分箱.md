# 一.连续变量分箱

## 1.分箱的含义和作用

### 1.1 含义

在实际的模型训练过程中，我们经常需要对连续型字段进行离散化处理，也就是将连续型的字段转化为离散字段。这个过程也可以看成是连续变量的重新编码，也可以称作是连续变量的分箱。

### 1.2 作用

连续字段在离散化之后，所表示的字段含义也发生了变化，比如从实际的用户收入变成了用户收入的等级划分。 连续字段的离散化能够更加简洁清晰的呈现特征信息，并且能够极大程度的减少异常值的影响，同时也能消除特征量纲的影响。

### 1.3 适用范围

对于很多**线性模型**来说，连续变量的分箱其实相当于在线性方程中引入了很多非线性因素，从而提升模型的表现。 当然连续变量分箱过程也会让连续变量损失一些信息，因此对于很多模型（比如**树模型**），分箱损失的信息则大概率会影响模型的最终效果。

## 2.根据业务进行分箱

在一些有明确业务背景的场景中，或许能够找到一些根据长期实践经验积累下来的业务指标来作为划分依据，例如很多金融行业会通过一些业务指标来对用户进行价值划分，例如会规定月收入10000以上属于高收入人群，此时10000就可以作为连续变量离散化的依据。

## 3.根据计算流程分箱

### 3.1 等宽分箱

等宽分箱，就是先确认数据划分成几份，然后根据连续变量的取值范围和期望分箱数划分出宽度相同的区间，并据此对连续变量进行分箱。

```python
import numpy as np
import pandas as pd
from sklearn.preprocessing import KBinsDiscretizer
X = np.random.randint(low=0,high=100,size=(10, 1),dtype='int')
kd = KBinsDiscretizer(n_bins=3, encode='ordinal', strategy='uniform')
kd.fit_transform(X)
```

- KBinsDiscretizer只支持列向量的格式
- nbin:表示期望的分箱个数
- strategy:表示分箱的策略，"uniform"代表等宽，"quantile"代表等频，"kmeans"代表聚类。
- encode:表示输入分箱后是否需要进一步独热编码或者onehot编码。

```python
#查看分箱的边界
kd.bin_edges_
```

需要注意的是分箱也需要在训练集上进行训练（找到分箱边界），在测试集上进行测试（利用分箱边界进行分箱）这一基本要求。

**等宽分箱的缺点：**等宽分箱会一定程序收到异常值的影响。

### 3.2 等频分箱

等频分箱是根据期望的分箱数量，对于样本进行划分，划分依据是能够让每一个箱子包含相同数量的样本。

```python
kd = KBinsDiscretizer(n_bins=3, encode='ordinal', strategy='quantile')
kd.fit_transform(X)
```

注意如果是除不尽的等频分箱情况，则余数会给到最后一个箱子。

**等频分箱的缺点：**等宽分箱容易完全忽略异常值信息，从而造成一定程度特征信息丢失。

### 3.3 聚类分箱

通过聚类算法的结果进行分箱，聚类过程能够更加完整的保留原始数值分布信息。

```python
kd = KBinsDiscretizer(n_bins=3, encode='ordinal', strategy='kmeans')
kd.fit_transform(X)
kd.bin_edges_
```

### 3.4 有监督分箱

根据标签取值对连续变量进行分箱。在这些方法中，最常用的分箱就是树模型分箱。

利用决策树模型进行分箱，简单根据决策树的树桩（每一次划分数据集的切分点）来作为连续变量的切分依据，由于决策树的分叉过程总是会选择让整体不纯度降低最快的切分点，因此这些切分点就相当于是最大程度保留了有利于样本分类的信息。

有监督分箱的缺点：有泄露标签信息的风险，可能造成过拟合。