# 一.时序特征衍生

## 1.pandas处理时间字段

pandas中对于时间格式的字段，可以将其转换为datetime格式，进而方便的提取到时间字段中的信息。datetime是pandas中专门用于记录时间对象的格式。对于datetime64来说有两种子类型，分别是datetime64[ns]毫秒格式与datetime64[D]日期格式。无论是哪种格式，我们可以通过pd.to_datetime函数对其进行转化。

```python
t = pd.DataFrame()
t['time'] = ['2022-01-03;02:31:52',
             '2022-07-01;14:22:01', 
             '2022-08-22;08:02:31', 
             '2022-04-30;11:41:31', 
             '2022-05-02;22:01:27']
t['time'] = pd.to_datetime(t['time'])
```

在转化为datetime64格式之后，我们就可以通过一些dt.func方式来提取时间中的关键信息，如年、月、日、小时、季节、一年的第几周等，常用方法如下所示：

| 方法      | 作用     |
| --------- | -------- |
| dt.year   | 提取年   |
| dt.month  | 提取月   |
| dt.day    | 提取日   |
| dt.hour   | 提取小时 |
| dt.minute | 提取分钟 |
| dt.second | 提取秒   |

```python
t['year'] =  t['time'].dt.year
t['month'] =  t['time'].dt.month
t['day'] =  t['time'].dt.day
t['hour'] =  t['time'].dt.hour
t['minute'] =  t['time'].dt.minute
t['second'] =  t['time'].dt.second
```

当然，除了用不同的列记录时序字段的年月日、时分秒之外，我们知道，还有一些自然周期也会对结果预测有较大影响，如日期所在季度。这里需要注意的是，对于时序字段，往往我们会尽可能的对其进行自然周期的划分，然后在后续进行特征筛选时再对这些衍生字段进行筛选，对于此前的数据集，我们能够清晰的看到季度特征对标签的影响，而很多时候，除了季度，诸如全年的第几周、一周的第几天，甚至是日期是否在周末，具体事件的时间是在上午、下午还是在晚上等，都会对预测造成影响。对于这些自然周期提取方法，有些自然周期可以通过dt的方法自动计算，另外则需要手动进行计算。首先我们先看能够自动完成计算的自然周期：

| 方法                     | 作用             |
| ------------------------ | ---------------- |
| dt.quarter               | 提取季度         |
| dt.weekofyear            | 提取年当中的周数 |
| dt.dayofweek, dt.weekday | 提取周几         |

dayofweek按照习惯可以+1，代表周一到周日

```python
t['time'].dt.dayofweek + 1
```

然后还可以创建是否是周末的字段：（注意这里是按照1-7对应周一到周日）

```python
t['weekend'] = (t['dayofweek'] > 5).astype(int) 
```

此外还可以划分一天内的周期，比如凌晨、上午、下午、晚上等等

```python
t['hour_section'] = (t['hour'] // 6).astype(int) 
```

至此，我们就完成了围绕时序字段的详细信息衍生（年月日、时分秒单独提取一列），以及基于自然周期划分的时序特征衍生（第几周、周几、是否是周末、一天中的时间段）。

![image-20220217202852046](https://s2.loli.net/2022/02/17/y7wctiB4EH3qkMV.png)

  当然整个时序字段的特征衍生过程并不复杂，接下来我们重点探讨为何我们需要对时序特征进行周期性划分，或者说，为何对时序特征进行有效的周期性划分是我们进一步挖掘时序特征背后有效信息的必要手段。

